with s1 as (select distinct household_number,person_id, avg(viewing_weight_1) as avg_weight from nielsen.npm_57 where viewing_source in ('AHC','APL','DAM','DFC','DISC','DLIF','ID','SCI','TLC','VE') and age_gender_building_block_code in ('G','H','I','V','W','X') and viewing_source_type_code='C' and broadcast_date between  '2014-11-10' and '2014-11-16' group by household_number, person_id), 
s3 as (select distinct household_number,person_id, viewing_source,broadcast_date,hour_start_time,day from nielsen.npm_57 where viewing_source in ('AHC','APL','DAM','DFC','DISC','DLIF','ID','SCI','TLC','VE') and age_gender_building_block_code in ('G','H','I','V','W','X') and viewing_source_type_code='C' and broadcast_date between  '2014-11-01' and '2015-01-01'), s4 as (select s3.household_number, s3.person_id, s3.viewing_source, s3.broadcast_date, s3.hour_start_time, s3.day, s1.avg_weight from s3 join s1 on s3.household_number=s1.household_number and s3.person_id=s1.person_id), s2 as (select
viewing_source,broadcast_date,day,hour_start_time, sum(avg_weight) as viewing_weight from s4 group by viewing_source,broadcast_date,day,hour_start_time) select viewing_source, day,hour_start_time, avg(viewing_weight)from s2 group by viewing_source,day,hour_start_time;
